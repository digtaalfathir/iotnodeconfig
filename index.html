<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>IoT-Node BLE Configuration</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
    :root {
      --bg: #f2f4f7;
      --card: #ffffff;
      --border: #d0d7de;
      --primary: #2563eb;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #f59e0b;
      --text: #111827;
      --muted: #6b7280;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text);
    }

    header {
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #e5e7eb;
      padding: 18px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header .title {
      font-size: 18px;
      font-weight: 600;
    }

    header .subtitle {
      font-size: 12px;
      color: #9ca3af;
    }

    .container {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .card h3 {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 0;
    }

    .card h3::before {
      content: "‚ñå";
      color: var(--primary);
      font-weight: bold;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
      color: var(--muted);
    }

    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 14px;
      background: #fff;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
    }

    input::placeholder {
      color: #9ca3af;
    }

    .btn {
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    /* ================== RULES SECTION ================== */
    .rule-card {
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .rule-card.disabled {
      opacity: 0.5;
      background: #f1f5f9;
    }

    .rule-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .rule-output {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
      min-width: 40px;
    }

    .rule-logic-select {
      width: 100px;
      padding: 8px 12px;
      font-weight: 600;
    }

    .rule-logic-select.logic-or {
      border-color: var(--success);
      background: #f0fdf4;
    }

    .rule-logic-select.logic-and {
      border-color: var(--primary);
      background: #eff6ff;
    }

    .rule-logic-select.logic-not {
      border-color: var(--warning);
      background: #fffbeb;
    }

    .rule-logic-select.logic-off {
      border-color: var(--border);
      background: #f9fafb;
    }

    .logic-description {
      font-size: 12px;
      color: var(--muted);
      font-style: italic;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 6px;
      margin-top: 8px;
    }

    .input-checkbox {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 8px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s;
      font-size: 13px;
    }

    .input-checkbox:hover {
      border-color: var(--primary);
    }

    .input-checkbox.checked {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .input-checkbox.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .input-checkbox input {
      width: auto;
      margin: 0;
      cursor: pointer;
    }

    .rule-warning {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      padding: 8px 12px;
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 6px;
      font-size: 12px;
      color: #92400e;
    }

    .rule-summary {
      margin-top: 10px;
      padding: 8px 12px;
      background: #e0f2fe;
      border-radius: 6px;
      font-size: 13px;
      color: #0369a1;
      font-family: monospace;
    }

    /* ================== ACTION PANEL ================== */
    .action-panel {
      position: sticky;
      bottom: 0;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 24px;
      padding: 16px;
      background: #f8fafc;
      border-top: 1px solid var(--border);
      z-index: 10;
    }

    .action-btn {
      height: 52px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
    }

    .action-btn.secondary {
      background: #374151;
      color: #fff;
    }

    .action-btn:hover {
      opacity: 0.92;
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255,255,255,0.4);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ================== MODAL ================== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
    }

    .modal-box {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 360px;
      text-align: center;
    }

    .modal-box h3 {
      margin-top: 0;
    }

    .modal-box button {
      margin-top: 16px;
    }

    #unsavedBadge {
      font-weight: 600;
    }

    footer {
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      margin-top: 30px;
      padding-bottom: 10px;
    }

    /* ================== LEGEND ================== */
    .logic-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 16px;
      padding: 12px;
      background: #fff;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    .legend-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 11px;
    }

    .legend-badge.or { background: #dcfce7; color: #166534; }
    .legend-badge.and { background: #dbeafe; color: #1e40af; }
    .legend-badge.not { background: #fef3c7; color: #92400e; }
  </style>
</head>

<body>

<header>
  <div>
    <div class="title">IoT-Node BLE Configuration</div>
    <div class="subtitle">Bluetooth Low Energy Setup</div>
  </div>

  <div style="display:flex; gap:10px;">
    <button class="btn btn-primary" onclick="connectBLE()">Connect BLE</button>
    <button class="btn" onclick="getConfig()">Get Config</button>
  </div>
</header>


<div class="container">

<!-- BASIC -->
<div class="card">
<h3>Basic Configuration</h3>
<div class="grid">
  <div>
    <label>Box ID</label>
    <input type="number" id="boxID" min="1" max="99">
  </div>
</div>
</div>

<!-- RTC -->
<div class="card">
  <h3>Timestamp</h3>

  <div class="grid">
    <div>
      <label>Date & Time</label>
      <input type="datetime-local" id="rtcDatetime">
    </div>
  </div>

  <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
    <button class="btn btn-primary" type="button" onclick="applyRTC()">
      ‚è± Apply Timestamp
    </button>
    <span id="rtcStatus" class="logic-description"></span>
  </div>
</div>


<!-- NETWORK -->
<div class="card">
  <h3>Network Configuration</h3>

  <div class="grid">
    <div>
      <label>Network Mode</label>
      <select id="networkMode" onchange="onNetworkModeChange()">
        <option value="wifi">WiFi Only</option>
        <option value="ethernet">Ethernet Only</option>
        <option value="hybrid">Hybrid (WiFi + Ethernet)</option>
      </select>
    </div>

    <div id="priorityWrapper" style="display:none;">
      <label>Primary Network</label>
      <select id="networkPriority">
        <option value="ethernet">Ethernet</option>
        <option value="wifi">WiFi</option>
      </select>
    </div>

    <div id="wifiSSIDWrapper" style="display:none;">
      <label>WiFi SSID</label>
      <input type="text" id="wifiSSID">
    </div>

    <div id="wifiPasswordWrapper" style="display:none;">
      <label>WiFi Password</label>
      <div style="display:flex; gap:6px;">
        <input type="password" id="wifiPassword" style="flex:1;">
        <button class="btn" type="button" onclick="togglePassword()">üëÅ</button>
      </div>
    </div>
  </div>
</div>


<!-- TRANSPORT -->
<div class="card">
  <h3>Transport Configuration</h3>
  <div class="grid">
    <div>
      <label>Protocol</label>
      <select id="commMode" onchange="enforceCommNetworkRule()">
        <option value="mqtt">MQTT</option>
        <option value="httppost">HTTP POST</option>
        <option value="tcp">TCP</option>
        <option value="ws">WebSocket</option>
      </select>
    </div>

    <div>
      <label>Server Host</label>
      <input type="text" id="serverIP">
    </div>

    <div>
      <label>Port</label>
      <input type="number" id="monitoringPort">
    </div>

    <div>
      <label>Path</label>
      <input type="text" id="serverPath">
    </div>
  </div>
</div>

<!-- RULES -->
<div class="card">
  <h3>Output Rules (Logic Gates)</h3>
  
  <div class="logic-legend">
    <div class="legend-item">
      <span class="legend-badge or">OR</span>
      <span>Output ON if <strong>ANY</strong> input is ON</span>
    </div>
    <div class="legend-item">
      <span class="legend-badge and">AND</span>
      <span>Output ON if <strong>ALL</strong> inputs are ON</span>
    </div>
    <div class="legend-item">
      <span class="legend-badge not">NOT</span>
      <span>Output ON if input is <strong>OFF</strong> (1 input only)</span>
    </div>
  </div>

  <div id="rulesContainer">
    <!-- Generated by JavaScript -->
  </div>
</div>

<div class="action-panel">
<button class="action-btn primary" onclick="saveConfig()">üíæ Save Config</button>
<button class="action-btn secondary" onclick="downloadConfig()">üì• Download JSON</button>
</div>

<footer>BLE Config Panel ‚Ä¢ IoT Node</footer>
</div>

<script>
/* ================= BLE ================= */
const SERVICE_UUID="4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const CHAR_UUID="beb5483e-36e1-4688-b7f5-ea07361b26a8";
const CHAR_UUID_RX="beb5483e-36e1-4688-b7f5-ea07361b26a8";
const CHAR_UUID_TX="beb5483e-36e1-4688-b7f5-ea07361b26a9";
let bleChar=null;

async function connectBLE() {
  const device = await navigator.bluetooth.requestDevice({
    acceptAllDevices: true,
    optionalServices: [SERVICE_UUID]
  });

  const server = await device.gatt.connect();
  const service = await server.getPrimaryService(SERVICE_UUID);
  bleChar = await service.getCharacteristic(CHAR_UUID);

  // ‚úÖ 1. PASANG LISTENER DULU
  bleChar.addEventListener(
    "characteristicvaluechanged",
    onBleMessage
  );

  // ‚úÖ 2. BARU START NOTIFY
  await bleChar.startNotifications();

  alert("BLE connected");
}

function onBleMessage(event) {
  const value = new TextDecoder().decode(event.target.value);
  console.log("[BLE RX]", value);

  if (value.startsWith("CFG:")) {
    const json = value.substring(4);
    const cfg = JSON.parse(json);
    applyConfigToUI(cfg);
  }
}

async function bleSend(txt){
  if(!bleChar) return alert("BLE not connected");
  await bleChar.writeValue(new TextEncoder().encode(txt));
}

/* ================= RULES ================= */
/* ================== RULES ENGINE ================== */
const NUM_INPUTS = 15;
const NUM_OUTPUTS = 4;

/*
outputRules = {
  Q1: { logic: "OR", inputs: ["I1","I2"] },
  Q2: { logic: "OFF", inputs: [] },
}
*/
let outputRules = {};

/* ---------- INIT ---------- */
function initRules() {
  for (let q = 1; q <= NUM_OUTPUTS; q++) {
    outputRules["Q" + q] = {
      logic: "OFF",
      inputs: []
    };
  }
}

/* ---------- RENDER ---------- */
function renderRules() {
  const container = document.getElementById("rulesContainer");
  container.innerHTML = "";

  for (let q = 1; q <= NUM_OUTPUTS; q++) {
    const qKey = "Q" + q;
    const rule = outputRules[qKey];

    const card = document.createElement("div");
    card.className = "rule-card" + (rule.logic === "OFF" ? " disabled" : "");
    card.id = "ruleCard" + q;

    /* ===== HEADER ===== */
    let headerHtml = `
      <div class="rule-header">
        <span class="rule-output">${qKey}</span>

        <select
          id="logic${q}"
          class="rule-logic-select logic-${rule.logic.toLowerCase()}"
          onchange="onLogicChange(${q})">

          <option value="OFF" ${rule.logic === "OFF" ? "selected" : ""}>OFF</option>
          <option value="OR"  ${rule.logic === "OR"  ? "selected" : ""}>OR</option>
          <option value="AND" ${rule.logic === "AND" ? "selected" : ""}>AND</option>
          <option value="NOT" ${rule.logic === "NOT" ? "selected" : ""}>NOT</option>
        </select>

        <span class="logic-description">
          ${getLogicDescription(rule.logic)}
        </span>
      </div>
    `;

    /* ===== INPUT GRID ===== */
    let inputsHtml = `<div class="input-grid">`;

    for (let i = 1; i <= NUM_INPUTS; i++) {
      const iKey = "I" + i;
      const checked = rule.inputs.includes(iKey);
      const disabled =
        rule.logic === "OFF" ||
        (rule.logic === "NOT" && rule.inputs.length >= 1 && !checked);

      inputsHtml += `
        <label class="input-checkbox
          ${checked ? "checked" : ""}
          ${disabled ? "disabled" : ""}">

          <input type="checkbox"
            ${checked ? "checked" : ""}
            ${disabled ? "disabled" : ""}
            onchange="onInputToggle(${q}, ${i})">

          ${iKey}
        </label>
      `;
    }
    inputsHtml += `</div>`;

    /* ===== NOT WARNING ===== */
    let warningHtml = "";
    if (rule.logic === "NOT") {
      warningHtml = `
        <div class="rule-warning">
          ‚ö†Ô∏è NOT logic allows only 1 input. Output will be ON when selected input is OFF.
        </div>
      `;
    }

    /* ===== SUMMARY ===== */
    let summaryHtml = "";
    if (rule.logic !== "OFF" && rule.inputs.length > 0) {
      summaryHtml = `
        <div class="rule-summary">
          üìã ${qKey} = ${formatRuleSummary(rule)}
        </div>
      `;
    }

    card.innerHTML = headerHtml + inputsHtml + warningHtml + summaryHtml;
    container.appendChild(card);
  }
}

/* ---------- HANDLERS ---------- */
function onLogicChange(q) {
  const qKey = "Q" + q;
  const select = document.getElementById("logic" + q);
  const newLogic = select.value;

  if (newLogic === "OFF") {
    outputRules[qKey].inputs = [];
  }

  if (newLogic === "NOT" && outputRules[qKey].inputs.length > 1) {
    outputRules[qKey].inputs = [outputRules[qKey].inputs[0]];
  }

  outputRules[qKey].logic = newLogic;
  renderRules();
}

function onInputToggle(q, i) {
  const qKey = "Q" + q;
  const iKey = "I" + i;
  const rule = outputRules[qKey];

  if (rule.logic === "OFF") return;

  if (rule.inputs.includes(iKey)) {
    rule.inputs = rule.inputs.filter(x => x !== iKey);
  } else {
    if (rule.logic === "NOT") {
      rule.inputs = [iKey];
    } else {
      rule.inputs.push(iKey);
    }
  }

  rule.inputs.sort((a, b) => parseInt(a.slice(1)) - parseInt(b.slice(1)));
  renderRules();
}

/* ---------- HELPERS ---------- */
function getLogicDescription(logic) {
  switch (logic) {
    case "OR":  return "ON if any selected input is ON";
    case "AND": return "ON if all selected inputs are ON";
    case "NOT": return "ON if selected input is OFF";
    default:    return "Output disabled";
  }
}

function formatRuleSummary(rule) {
  if (rule.logic === "NOT") {
    return `NOT(${rule.inputs[0]})`;
  }
  return rule.inputs.join(` ${rule.logic} `);
}

function setLogic(q,v){outputRules["Q"+q].logic=v;renderRules()}
function toggleInput(q,k){
  const r=outputRules["Q"+q];
  if(r.inputs.includes(k)) r.inputs=r.inputs.filter(x=>x!==k);
  else r.logic=="NOT"?r.inputs=[k]:r.inputs.push(k);
  renderRules();
}

/* ================= CONFIG ================= */
function getConfig(){
  return {
    device:{boxID:+boxID.value||0},
    network:{
      mode:networkMode.value,
      priority:networkPriority.value
    },
    transport:{
      type:commMode.value,
      host:serverIP.value,
      port:+monitoringPort.value||0,
      path:serverPath.value
    },
    wifi:{
      ssid:wifiSSID.value,
      password:wifiPassword.value
    },
    rules:Object.entries(outputRules)
      .filter(([k,v])=>v.logic!="OFF"&&v.inputs.length)
      .map(([k,v])=>`${k}:${v.logic}:${v.inputs.join(",")}`)
  };
}

async function saveConfig(){
  await bleSend("CMD:CONFIG:"+JSON.stringify(getConfig()));
  alert("Config sent via BLE");
}

async function applyRTC() {
  const input = document.getElementById("rtcDatetime");
  const status = document.getElementById("rtcStatus");

  if (!input.value) {
    status.textContent = "Please select date & time";
    status.style.color = "#dc2626";
    return;
  }

  // ubah "2025-05-20T12:34:56" ‚Üí "2025-05-20 12:34:56"
  const datetime = input.value.replace("T", " ");

  status.textContent = "Sending timestamp...";
  status.style.color = "#6b7280";

  try {
    await bleSend(`CMD:RTC:${datetime}`);

    status.textContent = "Timestamp sent successfully";
    status.style.color = "#16a34a";
  } catch (e) {
    status.textContent = "Failed to send timestamp";
    status.style.color = "#dc2626";
  }
}

function downloadConfig(){
  const blob=new Blob([JSON.stringify(getConfig(),null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="config.json";a.click();
}

function onNetworkModeChange() {
  const mode = document.getElementById("networkMode").value;

  const priority = document.getElementById("priorityWrapper");
  const ssid = document.getElementById("wifiSSIDWrapper");
  const pwd = document.getElementById("wifiPasswordWrapper");

  // Reset semua
  priority.style.display = "none";
  ssid.style.display = "none";
  pwd.style.display = "none";

  if (mode === "wifi") {
    // WiFi Only
    ssid.style.display = "block";
    pwd.style.display = "block";
  }
  else if (mode === "hybrid") {
    // Hybrid
    priority.style.display = "block";
    ssid.style.display = "block";
    pwd.style.display = "block";
  }
  // ethernet only ‚Üí semua hidden
}

function togglePassword() {
  const pwdInput = document.getElementById("wifiPassword");
  if (pwdInput.type === "password") {
    pwdInput.type = "text";
  } else {
    pwdInput.type = "password";
  }
}

function enforceCommNetworkRule() {
  const commMode = document.getElementById("commMode").value;
  const networkMode = document.getElementById("networkMode");

  const wifiOpt = networkMode.querySelector('option[value="wifi"]');
  const ethOpt  = networkMode.querySelector('option[value="ethernet"]');
  const hybOpt  = networkMode.querySelector('option[value="hybrid"]');

  if (commMode === "ws") {
    // ===== WebSocket ‚Üí WiFi ONLY =====
    networkMode.value = "wifi";

    ethOpt.disabled = true;
    hybOpt.disabled = true;

    // pastikan UI network update
    onNetworkModeChange();
  } else {
    // ===== Protocol lain ‚Üí semua mode boleh =====
    ethOpt.disabled = false;
    hybOpt.disabled = false;
  }
}

function initRTCInput() {
  const input = document.getElementById("rtcDatetime");
  if (!input) return;

  const now = new Date();

  // format ‚Üí YYYY-MM-DDTHH:MM:SS (required by datetime-local)
  const pad = n => n.toString().padStart(2, "0");

  const value =
    now.getFullYear() + "-" +
    pad(now.getMonth() + 1) + "-" +
    pad(now.getDate()) + "T" +
    pad(now.getHours()) + ":" +
    pad(now.getMinutes()) + ":" +
    pad(now.getSeconds());

  input.value = value;
}

function applyConfigToUI(cfg) {
  // BASIC
  boxID.value = cfg.device?.boxID ?? "";

  // NETWORK
  networkMode.value = cfg.network?.mode ?? "wifi";
  networkPriority.value = cfg.network?.priority ?? "ethernet";
  onNetworkModeChange();

  // WIFI
  wifiSSID.value = cfg.wifi?.ssid ?? "";
  wifiPassword.value = cfg.wifi?.password ?? "";

  // TRANSPORT
  commMode.value = cfg.transport?.type ?? "mqtt";
  serverIP.value = cfg.transport?.host ?? "";
  monitoringPort.value = cfg.transport?.port ?? "";
  serverPath.value = cfg.transport?.path ?? "";

  enforceCommNetworkRule();

  // RULES
  parseRulesArray(cfg.rules);
  renderRules();

  console.log("Config loaded from device");
}

function parseRulesArray(arr) {
  initRules();
  if (!Array.isArray(arr)) return;

  arr.forEach(str => {
    const [q, logic, inputs] = str.split(":");
    if (!outputRules[q]) return;
    outputRules[q].logic = logic;
    outputRules[q].inputs = inputs ? inputs.split(",") : [];
  });
}

async function getConfig() {
  if (!bleChar) {
    alert("BLE not connected");
    return;
  }

  console.log("Requesting config from device...");
  await bleSend("CMD:GET_CONFIG");
}

/* INIT */
initRules();
renderRules();
onNetworkModeChange();
enforceCommNetworkRule();
initRTCInput();
</script>
</body>
</html>
